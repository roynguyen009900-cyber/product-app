<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="productTable">
        <style>
            .variant-row {
                display: none;
            }

            .variant-row.expanded {
                display: table-row;
            }

            .toggle-variants {
                cursor: pointer;
                user-select: none;
            }

            .toggle-variants wa-icon {
                transition: transform 0.2s ease;
                margin-left: 0.3rem;
                font-size: 0.7rem;
            }

            .toggle-variants.open wa-icon {
                transform: rotate(90deg);
            }

            .actions-cell {
                display: flex;
                gap: 0.4rem;
                align-items: center;
            }

            .delete-dialog-body p {
                font-size: 0.9rem;
                color: var(--wa-color-neutral-500);
                margin: 0;
                line-height: 1.5;
            }

            .delete-dialog-actions {
                display: flex;
                gap: 0.5rem;
                justify-content: flex-end;
            }
        </style>

        <!-- Empty state -->
        <div th:if="${#lists.isEmpty(products)}" class="empty-state">
            <wa-icon name="box-seam" style="font-size: 3rem;"></wa-icon>
            <h3>No products found</h3>
            <p>Try adding a product manually.</p>
        </div>

        <!-- Products table -->
        <div th:if="${!#lists.isEmpty(products)}" class="table-container">
            <table>
                <thead>
                    <tr>
                        <th style="width: 60px;">Image</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Vendor</th>
                        <th>Price</th>
                        <th>Variants</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <th:block th:each="product, stat : ${products}">
                        <tr>
                            <td>
                                <img th:if="${product.imageUrl != null}" th:src="${product.imageUrl}"
                                    th:alt="${product.title}" class="product-image" loading="lazy">
                                <div th:if="${product.imageUrl == null}" class="product-image-placeholder">
                                    <wa-icon name="image"
                                        style="font-size: 1.2rem; color: var(--wa-color-neutral-400);"></wa-icon>
                                </div>
                            </td>
                            <td>
                                <strong th:text="${product.title}">Product Title</strong>
                                <br>
                                <span th:if="${product.handle != null}"
                                    style="font-size: 0.75rem; color: var(--wa-color-neutral-500);"
                                    th:text="'/' + ${product.handle}">/handle</span>
                            </td>
                            <td>
                                <span th:if="${product.productType != null}"
                                    style="font-size: 0.85rem; color: var(--wa-color-brand-600);"
                                    th:text="${product.productType}">Type</span>
                            </td>
                            <td th:text="${product.vendor}">Vendor</td>
                            <td class="price">
                                <span th:if="${product.price != null}"
                                    th:text="'$' + ${#numbers.formatDecimal(product.price, 1, 2)}">$0.00</span>
                            </td>
                            <td>
                                <span variant="success" size="small" class="toggle-variants"
                                    style="font-size: 0.85rem; color: var(--wa-color-success-600); cursor: pointer;"
                                    th:data-product="${stat.index}" onclick="toggleVariants(this)"
                                    th:text="${#lists.size(product.variants)} + ' variants'">0 variants</span>
                                <wa-icon name="chevron-down" style="font-size: 0.7rem; opacity: 0.6; cursor: pointer;"
                                    th:data-product="${stat.index}"
                                    onclick="toggleVariants(this.previousElementSibling)"></wa-icon>
                            </td>
                            <td>
                                <div class="actions-cell">
                                    <a th:href="@{/products/{id}/edit(id=${product.id})}">
                                        <wa-button size="small" variant="neutral">
                                            <wa-icon slot="prefix" name="pencil" style="font-size: 0.8rem;"></wa-icon>
                                            Edit
                                        </wa-button>
                                    </a>
                                    <wa-button size="small" variant="danger" outline th:data-product-id="${product.id}"
                                        th:data-product-title="${product.title}"
                                        onclick="openDeleteDialog(this.dataset.productId, this.dataset.productTitle)">
                                        <wa-icon slot="prefix" name="trash" style="font-size: 0.8rem;"></wa-icon>
                                        Delete
                                    </wa-button>
                                </div>
                            </td>
                        </tr>
                        <!-- Variant rows (collapsed by default) -->
                        <tr th:each="variant : ${product.variants}" class="variant-row" th:data-product="${stat.index}">
                            <td></td>
                            <td th:text="${variant.title}" style="padding-left: 2rem;">Variant Title</td>
                            <td>
                                <span th:if="${variant.sku != null}" style="font-size: 0.78rem; font-family: monospace;"
                                    th:text="${variant.sku}">SKU</span>
                            </td>
                            <td>
                                <!-- Options removed - now using title field only -->
                            </td>
                            <td class="price" th:text="'$' + ${#numbers.formatDecimal(variant.price, 1, 2)}">$0.00</td>
                            <td th:id="'variant-cell-' + ${variant.id}">
                                <span th:if="${variant.available}"
                                    style="font-size: 0.85rem; color: var(--wa-color-success-600); display: flex; align-items: center; gap: 0.4rem;">
                                    <wa-icon name="check-circle" style="font-size: 0.85rem;"></wa-icon>
                                    Available
                                    <wa-button size="small" variant="neutral" style="margin-left: 0.5rem;"
                                        th:hx-put="'/variants/' + ${variant.id} + '/toggle-availability'"
                                        th:hx-target="'#variant-cell-' + ${variant.id}" hx-swap="innerHTML">
                                        <wa-icon slot="prefix" name="toggle-on" style="font-size: 0.8rem;"></wa-icon>
                                        Toggle
                                    </wa-button>
                                </span>
                                <span th:unless="${variant.available}"
                                    style="font-size: 0.85rem; color: var(--wa-color-danger-600); display: flex; align-items: center; gap: 0.4rem;">
                                    <wa-icon name="x-circle" style="font-size: 0.85rem;"></wa-icon>
                                    Sold Out
                                    <wa-button size="small" variant="neutral" style="margin-left: 0.5rem;"
                                        th:hx-put="'/variants/' + ${variant.id} + '/toggle-availability'"
                                        th:hx-target="'#variant-cell-' + ${variant.id}" hx-swap="innerHTML">
                                        <wa-icon slot="prefix" name="toggle-off" style="font-size: 0.8rem;"></wa-icon>
                                        Toggle
                                    </wa-button>
                                </span>
                            </td>
                            <td></td>
                        </tr>
                    </th:block>
                </tbody>
            </table>
            <wa-divider></wa-divider>
            <div style="padding: 0.8rem 1rem; color: var(--wa-color-neutral-500); font-size: 0.82rem;">
                <wa-icon name="info-circle" style="margin-right: 0.3rem;"></wa-icon>
                <span th:text="${#lists.size(products)} + ' products loaded'">0 products loaded</span>
            </div>
        </div>

        <!-- Delete Confirmation Dialog -->
        <wa-dialog id="delete-dialog" label="Delete Product">
            <wa-icon slot="header-icon" name="exclamation-triangle-fill"
                style="color: var(--wa-color-danger-500); font-size: 1.2rem;"></wa-icon>
            <div class="delete-dialog-body">
                <p>Are you sure you want to delete <strong id="delete-product-name"></strong>? This action cannot be
                    undone.</p>
            </div>
            <div slot="footer" class="delete-dialog-actions">
                <wa-button data-dialog="close" variant="neutral" onclick="document.getElementById('delete-dialog').hide()">
                    Cancel
                </wa-button>
                <wa-button id="confirm-delete-btn" variant="danger" hx-swap="innerHTML"
                    hx-target="#product-table-container">
                    <wa-icon slot="prefix" name="trash"></wa-icon>
                    Delete
                </wa-button>
            </div>
        </wa-dialog>

        <script>
            function toggleVariants(tag) {
                const productId = tag.dataset.product;
                const rows = document.querySelectorAll(`.variant-row[data-product="${productId}"]`);
                const isOpen = tag.classList.toggle('open');
                rows.forEach(row => row.classList.toggle('expanded', isOpen));
            }

            function openDeleteDialog(productId, productName) {
                const dialog = document.getElementById('delete-dialog');
                document.getElementById('delete-product-name').textContent = productName;
                const confirmBtn = document.getElementById('confirm-delete-btn');
                confirmBtn.setAttribute('hx-delete', '/products/' + productId);
                htmx.process(confirmBtn);
                dialog.show();
            }

            document.addEventListener('htmx:afterRequest', function (event) {
                const dialog = document.getElementById('delete-dialog');
                if (dialog) {
                    dialog.hide();
                }
            });
        </script>
    </div>
</body>

</html>